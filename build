#!/bin/sh

# set -e

if [ -z "$1" -o -z "$2" -o -z "$3" ]; then
  echo "build <package> <version> <distro>"
  exit 1
elif [ ! -d "$1" ]; then
  echo "invalid package \"$1\""
  exit 1
fi

function distro_name {
  local IFS=':'; read -ra parts <<< "$1" # split on ":"
  printf "%s" "${parts[@]}"              # concatenate
}

package=$1
version=$2
distro=$( distro_name "$3" )

mkdir -p packages

docker build -t "fpm-${distro}" -f "Dockerfile.${distro}" .

docker run \
  --volume "$PWD/packages:/packages" \
  --volume "$PWD/${package}:/scripts" \
  --env-file "$PWD/.env" \
  --entrypoint "/scripts/entrypoint" \
  --rm \
  "fpm-${distro}" $version $distro
